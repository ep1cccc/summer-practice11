# SM2椭圆曲线密码算法实验报告

## 一、实验目的

1. 理解并实现SM2椭圆曲线密码算法的基本原理
2. 掌握SM2数字签名与验证的实现方法
3. 分析SM2算法在实际应用中可能存在的安全漏洞
4. 研究针对SM2算法的常见攻击方法，如固定随机数导致的私钥泄露
5. 探索数字签名的伪造技术与防御措施

## 二、实验环境

- 操作系统：不限（Windows/macOS/Linux均可）
- 编程语言：Python 3.x
- 依赖库：gmpy2（用于大数运算）、hashlib（用于哈希计算）
- 开发工具：任意Python集成开发环境或文本编辑器

## 三、实验原理

### 3.1 SM2椭圆曲线密码算法

SM2是中国国家密码管理局发布的椭圆曲线密码算法标准，包含数字签名、密钥交换和公钥加密等功能。本实验主要关注其数字签名功能。

SM2基于椭圆曲线离散对数问题(ECDLP)，其安全性依赖于求解椭圆曲线上离散对数的计算困难性。

椭圆曲线方程形式：y² = x³ + ax + b (mod p)，其中p为素数域参数

### 3.2 SM2数字签名流程

1. **签名过程**：
   - 选择随机数k ∈ [1, n-1]，计算点K = kG，其中G为基点
   - 计算r = (e + x₁) mod n，其中e为消息哈希值，(x₁, y₁)为K的坐标
   - 计算s = (inv(1 + d, n) × (k - r × d)) mod n，其中d为私钥
   - 签名结果为(r, s)

2. **验证过程**：
   - 计算e = H(msg)，t = (r + s) mod n
   - 计算u₁ = (e × t) mod n，u₂ = (r × t) mod n
   - 计算点X = u₁G + u₂P，其中P为公钥
   - 验证r ≡ (e + x₁) mod n是否成立，其中(x₁, y₁)为X的坐标

## 四、实验内容与步骤

### 4.1 SM2算法实现

1. **椭圆曲线参数定义**：实现SM2标准中定义的素数域参数p、曲线参数a和b、基点G、阶数n等

2. **椭圆曲线基本运算**：
   - 点加法：实现椭圆曲线上两点的加法运算
   - 点乘法：实现标量与点的乘法运算（基于二进制展开法）

3. **密钥对生成**：随机生成私钥d，并计算公钥P = dG

4. **签名与验证函数**：实现SM2的签名生成与验证功能

### 4.2 固定随机数k导致私钥泄露实验

1. 使用固定的随机数k对两个不同消息进行签名
2. 利用两个签名结果推导私钥d
3. 验证推导得到的私钥是否正确

### 4.3 中本聪签名伪造实验

1. 已知公钥的情况下，构造满足验证条件的伪造签名
2. 生成对应的伪造消息
3. 验证伪造签名的有效性

## 五、实验结果与分析

### 5.1 基础功能测试

运行代码中的基础签名与验证测试，结果如下：

```
基础签名验证: True
```

结果分析：实验成功实现了SM2的签名与验证功能，验证返回True表明签名有效，算法基本功能正常。

### 5.2 固定随机数k导致私钥泄露

实验结果示例：

```
=== 固定随机数k导致私钥泄露POC ===
真实私钥: 0x7f3a9b2c4d8e7f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5
恢复私钥: 0x7f3a9b2c4d8e7f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5
恢复成功: True
```

结果分析：
- 当使用固定随机数k对不同消息签名时，攻击者可以通过两个签名(r₁,s₁)和(r₂,s₂)推导出私钥d
- 推导公式：d = (s₁ - s₂) × inv(r₂ - r₁) mod n
- 这证明了在SM2签名中使用安全的随机数k的重要性，固定或可预测的随机数会导致严重的安全漏洞

### 5.3 中本聪签名伪造

实验结果示例：

```
=== 伪造中本聪签名 ===
伪造签名成功: r=0x5f3a7b9c2d4e6f8a1b3c5d7e9f0a2b4c6d8e0f1a3b5c7d9e0f2a4b6c8d0e1f3, s=0x1
伪造消息哈希: a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
```

结果分析：
- 通过构造特定参数，可以在已知公钥的情况下伪造有效的签名
- 伪造方法利用了签名验证过程中的数学特性，通过逆向推导构造满足条件的参数
- 这表明即使是标准的签名算法，在特定条件下也可能存在被伪造的风险

## 六、实验结论与思考

1. **SM2算法实现正确性**：实验成功实现了SM2椭圆曲线密码算法的签名与验证功能，验证了算法的基本原理。

2. **随机数的重要性**：实验证明，在SM2签名中使用固定或可预测的随机数k会导致私钥泄露，这强调了密码学中安全随机数生成的重要性。在实际应用中，必须使用 cryptographically secure pseudorandom number generator (CSPRNG) 来生成随机数。

3. **签名伪造的风险**：中本聪签名伪造实验展示了即使是标准的数字签名算法，在特定条件下也可能被伪造。这提醒我们在设计和使用签名系统时，需要考虑额外的安全措施，如时间戳、消息前缀等，以防止此类伪造攻击。

4. **哈希函数的作用**：本实验中使用SHA256模拟SM3哈希函数，实际应用中应使用标准的SM3哈希函数。哈希函数在数字签名中起到压缩消息和提供单向性的重要作用，其安全性直接影响整个签名体系的安全性。


